<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Terminal Integration Demo - Task 6</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .subtitle {
      opacity: 0.9;
      font-size: 1.1rem;
    }

    .grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 1024px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .card h2 {
      font-size: 1.3rem;
      margin-bottom: 15px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #terminal-container {
      background: #1e1e1e;
      border-radius: 8px;
      padding: 10px;
      height: 500px;              /* Fixed height instead of min-height */
      width: 100%;                /* Take full width of parent */
      overflow: hidden;           /* Changed from auto to hidden */
      position: relative;         /* For proper canvas positioning */
      box-sizing: border-box;     /* Include padding in dimensions */
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 15px;
    }

    button {
      padding: 12px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .stats {
      display: grid;
      gap: 10px;
      font-size: 14px;
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      padding: 8px;
      background: #f5f5f5;
      border-radius: 6px;
    }

    .stat-label {
      font-weight: 600;
      color: #666;
    }

    .stat-value {
      color: #333;
      font-family: 'Courier New', monospace;
    }

    .status-banner {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
      text-align: center;
    }

    .status-banner.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-banner.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status-banner.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .input-group {
      margin-bottom: 15px;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .event-log {
      max-height: 200px;
      overflow-y: auto;
      background: #f5f5f5;
      border-radius: 6px;
      padding: 10px;
      font-size: 12px;
      font-family: 'Courier New', monospace;
    }

    .event-item {
      padding: 4px 0;
      border-bottom: 1px solid #ddd;
    }

    .event-item:last-child {
      border-bottom: none;
    }

    .event-time {
      color: #666;
      margin-right: 8px;
    }

    .event-type {
      font-weight: 600;
      color: #667eea;
      margin-right: 8px;
    }

    .resize-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .resize-controls input {
      width: 100%;
    }

    .footer {
      text-align: center;
      color: white;
      opacity: 0.8;
      margin-top: 20px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üñ•Ô∏è Terminal Integration Demo</h1>
      <p class="subtitle">Task 6: Full Terminal with ScreenBuffer + VTParser + Renderer + Input</p>
    </header>

    <div id="status" class="status-banner info">
      ‚è≥ Initializing terminal...
    </div>

    <div class="grid">
      <!-- Terminal Display -->
      <div class="card">
        <h2>üì∫ Terminal Output</h2>
        <div id="terminal-container"></div>
      </div>

      <!-- Controls and Stats -->
      <div>
        <!-- Quick Actions -->
        <div class="card" style="margin-bottom: 20px;">
          <h2>üéÆ Quick Actions</h2>
          <div class="controls">
            <button onclick="testBasicOutput()">Basic Output</button>
            <button onclick="testColors()">Test Colors</button>
            <button onclick="testFormatting()">Test Formatting</button>
            <button onclick="testCursorMovement()">Cursor Movement</button>
            <button onclick="testClearScreen()">Clear Screen</button>
            <button onclick="testResetTerminal()">Reset Terminal</button>
          </div>
        </div>

        <!-- Custom Input -->
        <div class="card" style="margin-bottom: 20px;">
          <h2>‚úçÔ∏è Custom Input</h2>
          <div class="input-group">
            <label>Write to Terminal:</label>
            <textarea id="customInput" placeholder="Enter text or escape sequences...\nExample: \x1b[1;32mGreen text\x1b[0m"></textarea>
          </div>
          <button onclick="writeCustomInput()" style="width: 100%;">Write to Terminal</button>
        </div>

        <!-- Resize Controls -->
        <div class="card" style="margin-bottom: 20px;">
          <h2>üìê Resize Terminal</h2>
          <div class="resize-controls">
            <input type="number" id="cols" value="80" min="20" max="200" placeholder="Columns">
            <input type="number" id="rows" value="24" min="10" max="60" placeholder="Rows">
          </div>
          <button onclick="resizeTerminal()" style="width: 100%; margin-bottom: 10px;">Manual Resize</button>
          <button onclick="fitToContainer()" style="width: 100%;">üîÑ Fit to Container</button>
        </div>

        <!-- Stats -->
        <div class="card" style="margin-bottom: 20px;">
          <h2>üìä Terminal Stats</h2>
          <div class="stats">
            <div class="stat-item">
              <span class="stat-label">Dimensions:</span>
              <span class="stat-value" id="dimensions">-</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Data Events:</span>
              <span class="stat-value" id="dataEvents">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Bell Events:</span>
              <span class="stat-value" id="bellEvents">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Resize Events:</span>
              <span class="stat-value" id="resizeEvents">0</span>
            </div>
          </div>
        </div>

        <!-- Event Log -->
        <div class="card">
          <h2>üìú Event Log</h2>
          <div id="eventLog" class="event-log">
            <div class="event-item">
              <span class="event-time">--:--:--</span>
              <span class="event-type">INFO</span>
              <span>Waiting for initialization...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <p>Task 6: Terminal Class Integration | Ghostty WASM Terminal Emulator</p>
    </div>
  </div>

  <script type="module">
    import { Terminal, FitAddon } from '../lib/index.ts';

    // Global terminal instance
    window.term = null;
    window.fitAddon = null;
    let dataEventCount = 0;
    let bellEventCount = 0;
    let resizeEventCount = 0;

    // Utility: Show status message
    function showStatus(message, type = 'info') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status-banner ${type}`;
    }

    // Utility: Log event
    function logEvent(type, message) {
      const log = document.getElementById('eventLog');
      const time = new Date().toLocaleTimeString();
      const item = document.createElement('div');
      item.className = 'event-item';
      item.innerHTML = `
        <span class="event-time">${time}</span>
        <span class="event-type">${type}</span>
        <span>${message}</span>
      `;
      log.insertBefore(item, log.firstChild);
      
      // Keep only last 20 events
      while (log.children.length > 20) {
        log.removeChild(log.lastChild);
      }
    }

    // Utility: Update stats
    function updateStats() {
      if (window.term) {
        document.getElementById('dimensions').textContent = `${window.term.cols} √ó ${window.term.rows}`;
      }
      document.getElementById('dataEvents').textContent = dataEventCount;
      document.getElementById('bellEvents').textContent = bellEventCount;
      document.getElementById('resizeEvents').textContent = resizeEventCount;
    }

    // Initialize terminal
    async function initTerminal() {
      try {
        logEvent('INFO', 'Creating Terminal instance...');
        
        const term = new Terminal({
          cols: 80,
          rows: 24,
          scrollback: 1000,
          theme: {
            background: '#1e1e1e',
            foreground: '#d4d4d4',
            cursor: '#00ff00',
          }
        });

        logEvent('INFO', 'Opening terminal in container...');
        const container = document.getElementById('terminal-container');
        await term.open(container);

        // Load FitAddon
        logEvent('INFO', 'Loading FitAddon...');
        const fitAddon = new FitAddon();
        term.loadAddon(fitAddon);
        window.fitAddon = fitAddon;
        
        // Initial fit to container
        fitAddon.fit();
        logEvent('SUCCESS', `FitAddon fitted terminal to ${term.cols}√ó${term.rows}`);
        
        // Auto-fit on window resize
        fitAddon.observeResize();
        logEvent('INFO', 'FitAddon observing container resize');

        // Store globally
        window.term = term;

        // Wire up events
        term.onData(data => {
          dataEventCount++;
          updateStats();
          logEvent('DATA', `User input: ${JSON.stringify(data)}`);
          
          // Echo back for demo purposes with proper backspace handling
          // In a real terminal, the PTY would handle this
          if (data === '\x7F' || data === '\x08') {
            // Backspace: move back, erase character, move back again
            term.write('\b \b');
          } else if (data === '\r') {
            // Enter: carriage return + line feed
            term.write('\r\n');
          } else {
            // Regular character: just echo
            term.write(data);
          }
        });

        term.onBell(() => {
          bellEventCount++;
          updateStats();
          logEvent('BELL', 'Bell character received');
        });

        term.onResize(({ cols, rows }) => {
          resizeEventCount++;
          updateStats();
          logEvent('RESIZE', `Terminal resized to ${cols} √ó ${rows}`);
        });

        // Initial stats
        updateStats();

        // Write welcome message
        term.writeln('\x1b[1;36m‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\x1b[0m');
        term.writeln('\x1b[1;36m‚ïë         Welcome to Ghostty WASM Terminal Emulator         ‚ïë\x1b[0m');
        term.writeln('\x1b[1;36m‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\x1b[0m');
        term.writeln('');
        term.writeln('This terminal integrates \x1b[1mScreenBuffer\x1b[0m, \x1b[1mVTParser\x1b[0m, \x1b[1mCanvasRenderer\x1b[0m, and \x1b[1mInputHandler\x1b[0m.');
        term.writeln('');
        term.writeln('\x1b[32m‚úì Terminal initialized successfully!\x1b[0m');
        term.writeln('');
        term.writeln('Try typing something or click the buttons on the right ‚Üí');
        term.writeln('');

        showStatus('‚úÖ Terminal ready! Type in the terminal or use the buttons.', 'success');
        logEvent('SUCCESS', 'Terminal initialized and ready');

      } catch (error) {
        console.error('Failed to initialize terminal:', error);
        showStatus(`‚ùå Error: ${error.message}`, 'error');
        logEvent('ERROR', `Initialization failed: ${error.message}`);
      }
    }

    // Test Functions
    window.testBasicOutput = () => {
      if (!window.term) return;
      logEvent('TEST', 'Running basic output test');
      window.term.writeln('');
      window.term.writeln('=== Basic Output Test ===');
      window.term.writeln('Line 1: Hello, World!');
      window.term.writeln('Line 2: This is a terminal emulator');
      window.term.writeln('Line 3: Built with Ghostty + TypeScript + WebAssembly');
      window.term.writeln('');
    };

    window.testColors = () => {
      if (!window.term) return;
      logEvent('TEST', 'Running color test');
      window.term.writeln('');
      window.term.writeln('=== ANSI Color Test ===');
      
      // 16-color palette
      window.term.write('\x1b[30mBlack  \x1b[0m');
      window.term.write('\x1b[31mRed    \x1b[0m');
      window.term.write('\x1b[32mGreen  \x1b[0m');
      window.term.write('\x1b[33mYellow \x1b[0m');
      window.term.writeln('\x1b[34mBlue   \x1b[0m');
      
      window.term.write('\x1b[35mMagenta\x1b[0m');
      window.term.write('\x1b[36mCyan   \x1b[0m');
      window.term.write('\x1b[37mWhite  \x1b[0m');
      window.term.writeln('');
      
      // Bright colors
      window.term.write('\x1b[90mBright Black  \x1b[0m');
      window.term.write('\x1b[91mBright Red    \x1b[0m');
      window.term.write('\x1b[92mBright Green  \x1b[0m');
      window.term.writeln('\x1b[93mBright Yellow \x1b[0m');
      
      // RGB colors
      window.term.writeln('');
      window.term.write('\x1b[38;2;255;100;50mRGB: Orange\x1b[0m  ');
      window.term.write('\x1b[38;2;100;200;255mRGB: Sky Blue\x1b[0m  ');
      window.term.writeln('\x1b[38;2;255;50;200mRGB: Pink\x1b[0m');
      window.term.writeln('');
    };

    window.testFormatting = () => {
      if (!window.term) return;
      logEvent('TEST', 'Running formatting test');
      window.term.writeln('');
      window.term.writeln('=== Text Formatting Test ===');
      window.term.writeln('\x1b[1mBold text\x1b[0m');
      window.term.writeln('\x1b[3mItalic text\x1b[0m');
      window.term.writeln('\x1b[4mUnderlined text\x1b[0m');
      window.term.writeln('\x1b[9mStrikethrough text\x1b[0m');
      window.term.writeln('\x1b[1;3;4mBold + Italic + Underline\x1b[0m');
      window.term.writeln('\x1b[1;31;44mBold Red on Blue Background\x1b[0m');
      window.term.writeln('');
    };

    window.testCursorMovement = () => {
      if (!window.term) return;
      logEvent('TEST', 'Running cursor movement test');
      window.term.clear();
      window.term.write('\x1b[5;10HX marks the spot!');
      window.term.write('\x1b[10;20H‚Üê Here too');
      window.term.write('\x1b[15;30HAnd here ‚Üí');
      window.term.write('\x1b[20;15H‚Üì Bottom text ‚Üì');
      window.term.write('\x1b[1;1H'); // Home cursor
    };

    window.testClearScreen = () => {
      if (!window.term) return;
      logEvent('TEST', 'Clearing screen');
      window.term.clear();
      window.term.writeln('Screen cleared!');
      window.term.writeln('');
    };

    window.testResetTerminal = () => {
      if (!window.term) return;
      logEvent('TEST', 'Resetting terminal');
      window.term.reset();
      window.term.writeln('Terminal reset!');
      window.term.writeln('All state cleared, buffer recreated.');
      window.term.writeln('');
    };

    window.writeCustomInput = () => {
      if (!window.term) return;
      const input = document.getElementById('customInput').value;
      if (input) {
        logEvent('INPUT', `Writing custom input: ${input.substring(0, 50)}...`);
        // Process escape sequences
        const processed = input.replace(/\\x1b/g, '\x1b').replace(/\\n/g, '\n').replace(/\\r/g, '\r');
        window.term.write(processed);
      }
    };

    window.resizeTerminal = () => {
      if (!window.term) return;
      const cols = parseInt(document.getElementById('cols').value);
      const rows = parseInt(document.getElementById('rows').value);
      
      if (cols >= 20 && cols <= 200 && rows >= 10 && rows <= 60) {
        logEvent('RESIZE', `Resizing to ${cols} √ó ${rows}`);
        window.term.resize(cols, rows);
      } else {
        alert('Invalid dimensions. Cols: 20-200, Rows: 10-60');
      }
    };

    window.fitToContainer = () => {
      if (!window.fitAddon) return;
      logEvent('TEST', 'Fitting terminal to container');
      
      // Get proposed dimensions
      const dims = window.fitAddon.proposeDimensions();
      if (dims) {
        logEvent('INFO', `Proposed dimensions: ${dims.cols}√ó${dims.rows}`);
      }
      
      // Fit the terminal
      window.fitAddon.fit();
      logEvent('SUCCESS', `Terminal fitted to ${window.term.cols}√ó${window.term.rows}`);
      showStatus(`‚úÖ Terminal fitted to ${window.term.cols}√ó${window.term.rows}`, 'success');
    };

    // Initialize on load
    initTerminal();
  </script>
</body>
</html>
